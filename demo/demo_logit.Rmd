```{r Installing required packages}
install.packages(c("metafor","meta","weightr"))#When you use knitr,delete this chunk and sure every code is executable (e.g. you may need to specify your working directory)
```
```{r Loading packages}
library(metafor)
library(meta)
library(weightr)
```
```{r Reading in data}
dat=read.csv("D:/data/data.csv",header=T,sep=",")
```
```{r Calculating overall summary proportion}
ies.logit=escalc(xi=cases,ni=total,measure="PLO",data=dat)
pes.logit=rma(yi,vi,data=ies.logit,method="DL",weighted=TRUE)
pes=predict(pes.logit,transf=transf.ilogit)
print(pes,digits=6);print(pes.logit,digits=4);confint(pes.logit,digits=2)
```
```{r Calculating subgroup summary proportions according to study type}
pes.logit.birthcohort=rma(yi,vi,data=ies.logit,subset=studydesign=="Birth cohort",method="DL")
pes.logit.others=rma(yi,vi,data=ies.logit,subset=studydesign=="Others",method="DL")
pes.birthcohort=predict(pes.logit.birthcohort,transf=transf.ilogit,digits=5)
pes.others=predict(pes.logit.others,transf=transf.ilogit,digits=5)
print(pes.birthcohort,digits=5);print(pes.logit.birthcohort,digits=2);confint(pes.logit.birthcohort,digits=2)
print(pes.others,digits=5);print(pes.logit.others,digits=2);confint(pes.logit.others,digits=2)
```
```{r Identifying outliers with residuals}
stud.res=rstudent(pes.logit)
abs.z=abs(stud.res$z)
stud.res[order(-abs.z)]
```
```{r Leave-one-out analysis}
pes.leave1out=leave1out(pes.logit,transf=transf.ilogit)
print(pes.leave1out,digits=5)
```
```{r Baujat plot}
baujat(pes.logit)
```
```{r Diagnostic tests}
inf=influence(pes.logit)
print(inf);plot(inf)
```
```{r Removing outliers}
ies.logit.noutlier=escalc(xi=cases,ni=total,measure="PLO", data=dat[-c(2,3),])
pes.logit.noutlier=rma(yi,vi,data=ies.logit.noutlier,method="DL",weighted=TRUE)
pes.noutlier=predict(pes.logit.noutlier,transf=transf.ilogit)
print(pes,digits=5)
print(pes.noutlier,digits=5)
```
```{r Forest plot using metafor}
#If you want to create the forest plot manually, use the forest function in the metafor package. Numerical values in the following code are for demonstration purposes only. You need to change these values according to your data.
png("forestplot.png",width=730,height=700)
ies.summary=summary(ies.logit,transf=transf.ilogit,ni=dat$total)
forest(ies.summary$yi,
       ci.lb=ies.summary$ci.lb,ci.ub=ies.summary$ci.ub,
       slab=paste(dat$author,dat$year, sep=", "),
       ilab=cbind(data=dat$cases, dat$total),
       ilab.xpos=c(-0.002,-0.001),
       rows=c(19:14, 8.5:-1.5),
       at=c(seq(from=0,to=0.004,by=0.001)), 
       refline=pes$pred,
       ylim=c(-5,23),
       xlim=c(-0.005,0.005),
       pch=21,
       bg="grey",
       cex=1,
       font=1,
       main="Effect size by study type (RE Model)",
       xlab="Proportion",
       digits=4
       )
text(-0.005,22,pos=4,cex=1.2,font=1,"Author, Year")
text(c(-0.0023,-0.0013),22,pos=4,cex=1.2,font=1,c("Cases", "Total"))
text(0.003,22,pos=4,cex=1.2,font=1,"Proportion [95% CI]")
text(-0.005,c(9.7,20.2),pos=4, cex=1.2,font=1,c("Others", "Birth Cohort"))
addpoly(pes.birthcohort$pred,ci.lb=pes.birthcohort$ci.lb,ci.ub=pes.birthcohort$ci.ub,row=12.7,col="grey",digits=5,cex=1.1,mlab="")
addpoly(pes.others$pred,ci.lb=pes.others$ci.lb,ci.ub=pes.others$ci.ub,row=-2.7,col="grey",digits=5,cex=1.1,mlab="")
addpoly(pes$pred,ci.lb=pes$ci.lb,ci.ub=pes$ci.ub,row=-5,col="grey",digits=5,cex=1.1,mlab="")
text(-0.005,-5,pos=4,cex=1.1,bquote(paste("All studies (Q = ",.(formatC(pes.logit$QE, digits=1,format="f")), ", df = ", .(pes.logit$k - pes.logit$p),", p = ", .(formatC(pes.logit$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit$I2, digits=1, format="f")), "%",")")))
text(-0.005,12.7,pos=4,cex=1.1,bquote(paste("Subtotal(Q = ",.(formatC(pes.logit.birthcohort$QE, digits=1, format="f")), ", df = ", .(pes.logit.birthcohort$k - pes.logit.birthcohort$p),", p = ", .(formatC(pes.logit.birthcohort$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit.birthcohort$I2, digits=1, format="f")), "%",")")))
text(-0.005,-2.7,pos=4,cex=1.1,bquote(paste("Subtotal(Q = ",.(formatC(pes.logit.others$QE, digits=1, format="f")),", df = ", .(pes.logit.others$k - pes.logit.others$p), ", p = ", .(formatC(pes.logit.others$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit.others$I2, digits=1, format="f")), "%",")")))
abline(h=-4)
dev.off()
```
```{r Forest plot using meta}
#If you want to create the forest plot automatically, use the forest function in the meta package. Numerical values in the following code are for demonstration purposes only. You need to change these values according to your data.
pes.summary=metaprop(cases,total,authoryear,data=dat,byvar=studydesign,sm="PLO",method.ci="NAsm",method.tau="DL",incr=0.5,allincr=FALSE,addincr=FALSE,title="")
png("forestplot.png",width=700,height=600)
prop=dat$cases/dat$total
forest(pes.summary,
       sortvar=prop,
       xlim = c(0,4), pscale =1000, #if proportions are too low, consider rescaling proportions
       rightcols=FALSE,
       leftcols = c("studlab","effect", "ci"),#"event", "n","w.random" 
       leftlabs = c("Study","Proportion", "95% C.I."),#"Cases", "Total","Weights"
       xlab = "Proportion (â€°)", 
       fs.xlab=12,
       fs.study=12,
       fs.study.lables=12,
       fs.heading=12,
       squaresize = 0.5, col.square="navy", col.square.lines="navy",
       col.diamond="maroon", col.diamond.lines="maroon",
       comb.fixed=FALSE,
       lty.random=2, #lty.fixed=0,
       type.study="square",
       type.random="diamond",
       ff.random="bold", #ff.fixed="bold",
       hetlab = "Heterogeneity:",
       fs.hetstat=10,
       smlab="",
       print.Q=TRUE,
       print.pval.Q=TRUE,
       print.I2=TRUE,
       print.tau2=FALSE,
       col.by="black",
       digits=2,
       digits.Q=0)
dev.off()
```
```{r Subgroup analysis assuming a common among-study variance component across subgroups}
#Pool within-group estimates of tau-squared.
subganal.worldregion=rma(yi,vi,data=ies.logit,mods=~worldregion,method="REML")
subganal.researchperiod=rma(yi,vi,data=ies.logit,mods=~researchperiod,method="REML")
subganal.agediagnosed=rma(yi,vi,data=ies.logit,mods=~agediagnosed,method="REML")
subganal.samplesize=rma(yi,vi,data=ies.logit,mods=~samplesize,method="REML")
subganal.studydesign=rma(yi,vi,data=ies.logit,mods=~studydesign,method="DL")
subganal.periodagesize=rma(yi,vi,data=ies.logit,mods=~researchperiod+agediagnosed+samplesize,method="REML")
print(subganal.worldregion,digits=4)
print(subganal.researchperiod,digits=4)
print(subganal.agediagnosed,digits=4)
print(subganal.samplesize,digits=4)
print(subganal.studydesign,digits=4)
print(subganal.periodagesize,digits=4)
```
```{r Subgroup analysis not assuming a common among-study variance component across subgroups}
#Do not pool within-group estimates of tau-squared. This is the option used by RevMan.
dat.diffvar=data.frame(estimate=c(pes.logit.birthcohort$b,pes.logit.others$b),stderror=c(pes.logit.birthcohort$se, pes.logit.others$se),studydesign = c("Birth cohort","Others"), tau2=round(c(pes.logit.birthcohort$tau2, pes.logit.others$tau2),3))
subganal.studydesign=rma(estimate,sei=stderror,mods=~studydesign,method="FE",data=dat.diffvar)
print(subganal.studydesign,digits=2)
```
```{r Scatterplot for study type}
subganal.studesg=rma(yi,vi,data=ies.logit,mods=~studesg,method="REML")
preds.studesg=predict(subganal.studesg,newmods=c(0:2),transf=transf.ilogit)
wi=1/sqrt(ies.logit$vi)
size=1+3*(wi-min(wi))/(max(wi)-min(wi))
plot(ies.logit$studesg,transf.ilogit(ies.logit$yi),cex=size,pch=1,las=1,xlab="Study Type", ylab="Proportion")
lines(0:2,preds.studesg$pred,col="navy")
lines(0:2,preds.studesg$ci.lb,lty="dashed",col="maroon")
lines(0:2,preds.studesg$ci.ub,lty="dashed",col="maroon")
ids=c(1:6)
pos=c(2)
text(ies.logit$studesg[ids],transf.ilogit(ies.logit$yi)[ids],ids,cex=0.9,pos=pos)
```
```{r Scatterplot for sample size}
subganal.size=rma(yi,vi,data=ies.logit,mods=~size,method="REML")
preds.size=predict(subganal.size,newmods=c(0:2))
wi=1/sqrt(ies.logit$vi)
size=1+3*(wi-min(wi))/(max(wi)-min(wi))
plot(ies.logit$size,ies.logit$yi,cex=size,pch=1,las=1,xlab="Sample size", ylab="Logit event rate")
lines(0:2,preds.size$pred,col="navy")
lines(0:2,preds.size$ci.lb,lty="dashed",col="maroon")
lines(0:2,preds.size$ci.ub,lty="dashed",col="maroon")
ids=c(1:6)
pos=c(2)
text(ies.logit$size[ids],ies.logit$yi[ids],ids,cex=0.9,pos=pos)
```
```{r Funnel plot}
#If you want the x-axis to be expressed as a logit transformed proportion, then remove the "#" sign before the following line.
funnel(pes.logit,yaxis="sei")
#If you want the x-axis to be expressed as a proportion, then remove the "#" sign before the following line.
#funnel(pes.logit,atransf=transf.ilogit,yaxis="sei",xlab="Proportion",digits=6)
```
```{r Trim and fill plot}
pes.trimfill=trimfill(pes.logit)
#If you want the x-axis to be expressed as a logit transformed proportion, then remove the "#" sign before the following line.
funnel(pes.trimfill)
#If you want the x-axis to be expressed as a proportion, then remove the "#" sign before the following line.
#funnel(pes.trimfill,atransf=transf.ilogit,yaxis="sei",xlab="Proportion",digits=6)
predict(pes.trimfill,transf=transf.ilogit)
```
```{r Eggers regression test}
regtest(pes.logit,model="lm",predictor="sei")#warning: when using knitr, the "'" in the "Egger's" should be deleted
```
```{r Rank correlation}
ranktest(pes.logit)
```
```{r Vevea and Hedges Weight-Function Model}
weightfunct(ies.logit$yi,ies.logit$vi,steps=0.05)
```
```{r Failsafe N test}
fsn(yi,vi,data=ies.logit)
```