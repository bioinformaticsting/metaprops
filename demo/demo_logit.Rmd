```{r Installing required packages}
install.packages(c("metafor","meta","weightr"))#When you use knitr,delete this chunk and sure every code is executable (e.g. you may need to specify your working directory)
```
```{r Loading packages}
library(metafor)
library(meta)
library(weightr)
```
```{r Reading in data}
dat=read.csv("D:/data/data_logit.csv",header=T,sep=",")
```
```{r Calculating overall summary proportion}
ies.logit=escalc(xi=cases,ni=total,measure="PLO",data=dat)
pes.logit=rma(yi,vi,data=ies.logit,method="DL",weighted=TRUE)
pes=predict(pes.logit,transf=transf.ilogit)
print(pes,digits=6);print(pes.logit,digits=4);confint(pes.logit,digits=2)
```
```{r Identifying outliers with residuals}
stud.res=rstudent(pes.logit)
abs.z=abs(stud.res$z)
stud.res[order(-abs.z)]
```
```{r Leave-one-out analysis}
pes.leave1out=leave1out(pes.logit,transf=transf.ilogit)
print(pes.leave1out,digits=5)
```
```{r Baujat plot}
baujat(pes.logit,xlab="Contribution to Q-statistic", ylab="Influence on Summary Proportion")
```
```{r Diagnostic tests}
inf=influence(pes.logit)
print(inf);plot(inf)
```
```{r Removing outliers}
ies.logit.noutlier=escalc(xi=cases,ni=total,measure="PLO", data=dat[-c(2,3),])
pes.logit.noutlier=rma(yi,vi,data=ies.logit.noutlier,method="DL",weighted=TRUE)
pes.noutlier=predict(pes.logit.noutlier,transf=transf.ilogit)
print(pes,digits=5)
print(pes.noutlier,digits=5)
```
```{r Forest plot using metafor}
#If you want to create the forest plot manually, use the forest function in the metafor package. Numerical values in the following code are for demonstration purposes only. You need to change these values according to your data.
png("forestplot.png",width=730,height=700)
ies.summary=summary(ies.logit,transf=transf.ilogit,ni=dat$total)
forest(ies.summary$yi,
       ci.lb=ies.summary$ci.lb,ci.ub=ies.summary$ci.ub,
       slab=paste(dat$author,dat$year, sep=", "),
       ilab=cbind(data=dat$cases, dat$total),
       ilab.xpos=c(-0.002,-0.001),
       rows=c(19:14, 8.5:-1.5),
       at=c(seq(from=0,to=0.004,by=0.001)), 
       refline=pes$pred,
       ylim=c(-5,23),
       xlim=c(-0.005,0.005),
       pch=21,
       bg="grey",
       cex=1,
       font=1,
       main="Effect size by study type (RE Model)",
       xlab="Proportion",
       digits=4
       )
text(-0.005,22,pos=4,cex=1.2,font=1,"Author, Year")
text(c(-0.0023,-0.0013),22,pos=4,cex=1.2,font=1,c("Cases", "Total"))
text(0.003,22,pos=4,cex=1.2,font=1,"Proportion [95% CI]")
text(-0.005,c(9.7,20.2),pos=4, cex=1.2,font=1,c("Others", "Birth Cohort"))
addpoly(pes.birthcohort$pred,ci.lb=pes.birthcohort$ci.lb,ci.ub=pes.birthcohort$ci.ub,row=12.7,col="grey",digits=5,cex=1.1,mlab="")
addpoly(pes.others$pred,ci.lb=pes.others$ci.lb,ci.ub=pes.others$ci.ub,row=-2.7,col="grey",digits=5,cex=1.1,mlab="")
addpoly(pes$pred,ci.lb=pes$ci.lb,ci.ub=pes$ci.ub,row=-5,col="grey",digits=5,cex=1.1,mlab="")
text(-0.005,-5,pos=4,cex=1.1,bquote(paste("All studies (Q = ",.(formatC(pes.logit$QE, digits=1,format="f")), ", df = ", .(pes.logit$k - pes.logit$p),", p = ", .(formatC(pes.logit$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit$I2, digits=1, format="f")), "%",")")))
text(-0.005,12.7,pos=4,cex=1.1,bquote(paste("Subtotal(Q = ",.(formatC(pes.logit.birthcohort$QE, digits=1, format="f")), ", df = ", .(pes.logit.birthcohort$k - pes.logit.birthcohort$p),", p = ", .(formatC(pes.logit.birthcohort$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit.birthcohort$I2, digits=1, format="f")), "%",")")))
text(-0.005,-2.7,pos=4,cex=1.1,bquote(paste("Subtotal(Q = ",.(formatC(pes.logit.others$QE, digits=1, format="f")),", df = ", .(pes.logit.others$k - pes.logit.others$p), ", p = ", .(formatC(pes.logit.others$QEp, digits=2, format="f")), "; ", I^2, " = ",.(formatC(pes.logit.others$I2, digits=1, format="f")), "%",")")))
abline(h=-4)
dev.off()
```
```{r Forest plot using meta}
#If you want to create the forest plot automatically, use the forest function in the meta package. Numerical values in the following code are for demonstration purposes only. You need to change these values according to your data.
pes.summary=metaprop(cases,total,authoryear,data=dat,byvar=studesg,sm="PLO",method.ci="NAsm",method.tau="DL",incr=0.5,allincr=FALSE,addincr=FALSE,title="")
png("forestplot.png",width=700,height=600)
prop=dat$cases/dat$total
precison=sqrt(ies.logit$vi)
forest(pes.summary,
       #sortvar=prop,
       xlim = c(0,4), pscale =1000, #if proportions are too low, consider rescaling proportions
       rightcols=FALSE,
       leftcols = c("studlab","effect", "ci"),#"event", "n","w.random" 
       leftlabs = c("Study","Proportion", "95% C.I."),#"Cases", "Total","Weights"
       xlab = "Proportion (бы)", 
       fs.xlab=12,
       fs.study=12,
       fs.study.lables=12,
       fs.heading=12,
       squaresize = 0.5, col.square="navy", col.square.lines="navy",
       col.diamond="maroon", col.diamond.lines="maroon",
       comb.fixed=FALSE,
       lty.random=2, #lty.fixed=0,
       type.study="square",
       type.random="diamond",
       ff.random="bold", #ff.fixed="bold",
       hetlab = "Heterogeneity:",
       fs.hetstat=10,
       smlab="",
       print.Q=TRUE,
       print.pval.Q=TRUE,
       print.I2=TRUE,
       print.tau2=FALSE,
       col.by="black",
       digits=4,
       digits.Q=0)
dev.off()
```
```{r Calculating subgroup summary proportions, conducting subgroup analysis, and recalculating summary proportion assuming a common between-study variance component across subgroups}
#Pool within-group estimates of tau-squared (between-study variance):0.4427 is the combined tau^2 yielded by pooling 0.93224 and 0.24743
#Residual heterogeneity is heterogeneity not explained by the covariate (Thompson and Sharp, 1999). The results of the Test for Residual Heterogeneity show that there is significant unexplained variance left between all effect sizes in the dataset, which can explain why R^2 shows 0%
#The category that is coded as 0 (ie Birth cohort) will become the reference category (represented by the intercept).The other category coded as 1 (ie Others) will be compared against the reference category.
#The value of the intercept is the logit-transformed summary(mean) effect size of the studies in the reference category (ie Birth cohort)
#The summary effect size of the studies in the other category(ie Others) equals to -7.9742+0.3452=-7.629
#To create multivariate model:subganal.sizedesign=rma(yi,vi,data=ies.logit,mods=~samplesize+studydesign,method="DL")
subganal.studydesign=rma(yi,vi,data=ies.logit,mods=~studydesign,method="DL")
pes.logit.birthcohort=rma(yi,vi,data=ies.logit,mods=~studydesign=="Others",method="DL")
pes.logit.others=rma(yi,vi,data=ies.logit,mods=~studydesign=="Birth cohort",method="DL")
pes.subg.studydesign=predict(subganal.studydesign,transf=transf.ilogit)
dat.samevar=data.frame(estimate=c((pes.logit.birthcohort$b)[1],(pes.logit.others$b)[1]),
                       stderror=c((pes.logit.birthcohort$se)[1],(pes.logit.others$se)[1]),
                       tau2=subganal.studydesign$tau2)
pes.logit.studydesign=rma(estimate,sei=stderror,method="FE",data=dat.samevar)
pes.studydesign=predict(pes.logit.studydesign,transf=transf.ilogit)
#print(pes.subg.studydesign[order(pes.subg.studydesign$pred)],digits=6)
print(pes.studydesign,digits=6)
print(pes.subg.studydesign[1],digits=6);print(pes.subg.studydesign[17],digits=6)
print(subganal.studydesign,digits=4)
```
```{r Calculating subgroup summary proportions, conducting subgroup analysis, and recalculating summary proportion not assuming a common between-study variance component across subgroups}
#Calculating each subgroup summary proportion as an independent meta-analysis ignoring subgrouping
#Do not pool within-group estimates of tau-squared
pes.logit.birthcohort=rma(yi,vi,data=ies.logit,subset=studydesign=="Birth cohort",method="DL")
pes.logit.others=rma(yi,vi,data=ies.logit,subset=studydesign=="Others",method="DL")
pes.birthcohort=predict(pes.logit.birthcohort,transf=transf.ilogit,digits=5)
pes.others=predict(pes.logit.others,transf=transf.ilogit,digits=5)
dat.diffvar=data.frame(estimate=c(pes.logit.birthcohort$b,pes.logit.others$b),
                       stderror=c(pes.logit.birthcohort$se,pes.logit.others$se),
                       studydesign=c("Birth cohort","Others"), 
                       tau2=round(c(pes.logit.birthcohort$tau2, pes.logit.others$tau2),3))
subganal.studydesign=rma(estimate,sei=stderror,mods=~studydesign,method="FE",data=dat.diffvar)
pes.logit.studydesign=rma(estimate,sei=stderror,method="FE",data=dat.diffvar)
pes.studydesign=predict(pes.logit.studydesign,transf=transf.ilogit)
print(pes.birthcohort,digits=6);print(pes.logit.birthcohort,digits=3);confint(pes.logit.birthcohort,digits=5)
print(pes.others,digits=6);print(pes.logit.others,digits=3);confint(pes.logit.others,digits=5)
print(subganal.studydesign,digits=3)
print(pes.studydesign,digits=6)
print(pes.logit.studydesign,digits=6)
```
```{r Scatterplot for study design}
#Assuming a common between-study variance component across subgroups
#0.3452 is the coeffecient for the study design moderator;the pvals of QM and zval indicate this moderator is not significant
subganal.studesg=rma(yi,vi,data=ies.logit,mods=~studesg,method="DL")
preds.studesg=predict(subganal.studesg,newmods=c(0:2),transf=transf.ilogit)
wi=1/sqrt(ies.logit$vi)
size=1+3*(wi-min(wi))/(max(wi)-min(wi))
plot(ies.logit$studesg,transf.ilogit(ies.logit$yi),cex=size,pch=1,las=1,xlab="Study Design", ylab="Proportion")
lines(0:2,preds.studesg$pred,col="navy")
lines(0:2,preds.studesg$ci.lb,lty="dashed",col="maroon")
lines(0:2,preds.studesg$ci.ub,lty="dashed",col="maroon")
ids=c(1:6)
pos=c(2)
text(ies.logit$studesg[ids],transf.ilogit(ies.logit$yi)[ids],ids,cex=0.9,pos=pos)
```
```{r Scatterplot for sample size}
subganal.size=rma(yi,vi,data=ies.logit,mods=~size,method="REML")
preds.size=predict(subganal.size,newmods=c(0:2))
wi=1/sqrt(ies.logit$vi)
size=1+3*(wi-min(wi))/(max(wi)-min(wi))
plot(ies.logit$size,ies.logit$yi,cex=size,pch=1,las=1,xlab="Sample size", ylab="Logit event rate")
lines(0:2,preds.size$pred,col="navy")
lines(0:2,preds.size$ci.lb,lty="dashed",col="maroon")
lines(0:2,preds.size$ci.ub,lty="dashed",col="maroon")
ids=c(1:6)
pos=c(2)
text(ies.logit$size[ids],ies.logit$yi[ids],ids,cex=0.9,pos=pos)
```
```{r Funnel plot}
#If you want the x-axis to be expressed as a logit transformed proportion, then remove the "#" sign before the following line.
funnel(pes.logit,yaxis="sei")
#If you want the x-axis to be expressed as a proportion, then remove the "#" sign before the following line.
#funnel(pes.logit,atransf=transf.ilogit,yaxis="sei",xlab="Proportion",digits=6)
```
```{r Trim and fill plot}
pes.trimfill=trimfill(pes.logit)
#If you want the x-axis to be expressed as a logit transformed proportion, then remove the "#" sign before the following line.
funnel(pes.trimfill)
#If you want the x-axis to be expressed as a proportion, then remove the "#" sign before the following line.
#funnel(pes.trimfill,atransf=transf.ilogit,yaxis="sei",xlab="Proportion",digits=6)
predict(pes.trimfill,transf=transf.ilogit)
```
```{r Eggers regression test}
regtest(pes.logit,model="lm",predictor="sei")#warning: when using knitr, the "'" in the "Egger's" should be deleted
```
```{r Rank correlation}
ranktest(pes.logit)
```
```{r Vevea and Hedges Weight-Function Model}
weightfunct(ies.logit$yi,ies.logit$vi,steps=0.05)
```
```{r Failsafe N test}
fsn(yi,vi,data=ies.logit)
```