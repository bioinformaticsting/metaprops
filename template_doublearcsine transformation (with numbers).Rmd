```{r install required packages}
#install.packages('metafor')
#install.packages('meta')
#install.packages('weightr')
```
```{r load required packages}
library(metafor)
library(meta)
library(weightr)
```
```{r read data files}
setwd("D:/mydata")
dat=read.csv("filename.csv",header=T,sep=",")
```
```{r calculate overall effect sizes and subgroup es using the Freeman-Tukey double arcsine transformation}
ies.ft=escalc(measure="PFT",xi=cases,ni=total,data=dat, add=0)
pes.ft=rma(yi,vi,data=ies.ft,method="FE",weighted=TRUE)
pes.ft.mal1=rma(yi,vi,data=ies.ft,subset=moderatora=="level1",method="FE")
pes.ft.mal2=rma(yi,vi,data=ies.ft,subset=moderatora=="level2",method="FE")
pes=predict(pes.ft,transf=transf.ipft.hm,targ=list(ni=dat$total))
pes.level1=predict(pes.ft.mal1,transf=transf.ipft.hm,targ=list(ni=dat$total))
pes.level2=predict(pes.ft.mal2,transf=transf.ipft.hm,targ=list(ni=dat$total))
##pes=predict(pes.ft,transf=transf.iarcsin)
##pes.level1=predict(pes.ft.mal1,transf=transf.iarcsin)
##pes.level2=predict(pes.ft.mal2,transf=transf.iarcsin)
print(pes)
print(pes.level1)
print(pes.level2)
```
```{r forest plot using double arcsine transformed data}
pes.forest=summary(ies.ft,transf=transf.ipft,ni=dat$total)
forest(pes.forest$yi,ci.lb=pes.forest$ci.lb,ci.ub=pes.forest$ci.ub,
       ylim=c(-2,41),#vertical limits
       xlim=c(-2,2.1),#horizontal limits
       rows=c(36:20, 13:2),#1 is the row above the line below;ylim and rows both determine the position of studies
       main="Effect size by moderatora (FE model)",
       ilab=cbind(data=dat$cases, dat$total),#show cases and total
       ilab.xpos=c(-0.8, -0.5),#position of cases and total
       slab=paste(dat$author, dat$year, sep=", "),
       refline=pes$pred,#reference line position
       at=c(seq(from=0,to=0.5,by=0.1)), #legendary lenghth
       xlab="Proportion",#legendary lable
       cex=1,#overall font size
       font=6
       )
text(-2, 41,pos=4,cex=1,font=6,"Author(s), Year")
text(-2,c(14.5,37.5),pos=4, cex=1,font=6,c("level2", "level1"))
text(c(-0.9,-0.6), 41,pos=4,cex=1,font=6,c("Cases", "Total"))
text(1.2,41,pos=4,font=6,cex=1,"Proportion [95% CI]")
addpoly(pes.level1$pred,ci.lb=pes.level1$ci.lb,ci.ub=pes.level1$ci.ub,row=18.5,cex=0.8,mlab="")
addpoly(pes.level2$pred,ci.lb=pes.level2$ci.lb,ci.ub=pes.level2$ci.ub,row=0.5,cex=0.8,mlab="")
addpoly(pes$pred,ci.lb=pes$ci.lb,ci.ub=pes$ci.ub,row=-3,cex=0.8,mlab="")
text(-2,-3,pos=4,cex=0.8,
     bquote(paste("All studies (Q = ",.(formatC(pes.ft$QE, format="f")), ", df = ", .(pes.ft$k - pes.ft$p),", p = ", .(formatC(pes.ft$QEp, format="f")), 
     "; ", I^2, " = ",.(formatC(pes.ft$I2, format="f")), "%",")")))
text(-2,18.5,pos=4,cex=0.8,
     bquote(paste("Subtotal(Q = ",.(formatC(pes.ft.mal1$QE, format="f")), ", df = ", .(pes.ft.mal1$k - pes.ft.mal1$p),", p = ", .(formatC(pes.ft.mal1$QEp, format="f")),
"; ", I^2, " = ",.(formatC(pes.ft.mal1$I2, format="f")), "%",")")))
text(-2,0.5,pos=4,cex=0.8,
     bquote(paste("Subtotal(Q = ",.(formatC(pes.ft.mal2$QE, format="f")),", df = ", .(pes.ft.mal2$k - pes.ft.mal2$p), 
     ", p = ", .(formatC(pes.ft.mal2$QEp, format="f")), 
     "; ", I^2, " = ",.(formatC(pes.ft.mal2$I2, format="f")), "%",")")))
abline(h=-2)
```
```{r check evidence of heterogeneity}
print(pes.ft)
print(pes.ft.mal1)
print(pes.ft.mal2)
```
```{r baujat plot}
baujat(pes.ft)
```
```{r A set of diagnostic tests}
pes.inf=influence(pes.ft)#note I changed inf.pes to pes.inf
print(pes.inf)
plot(pes.inf)
```
```{r leave one out analysis}
pes.leave1out=leave1out(pes.ft,transf=transf.ipft.hm,targ=list(ni=dat$total))
print(pes.leave1out)
```
```{r subgroup analysis}
#if you assume a common variance
subganal.moderatora=rma(yi,vi, data=ies.ft, mods = ~ moderatora, method="FE")
print(subganal.moderatora)
#if you do not assume a common variance
#dat.diffvar= data.frame(estimate=c(pes.ft.mal1$b, pes.ft.mal2$b),stderror=c(pes.ft.mal1$se, pes.ft.mal2$se),moderatora = c("level1","level2"), tau2=round(c(pes.ft.mal1$tau2, pes.ft.mal2$tau2),3))
#subganal.moderatora=rma(estimate, sei=stderror, mods = ~ moderatora, method="FE", data=dat.diffvar)
#print(subganal.moderatora)
```
```{r funnel plot with double arcsine transformed data}
#transformed scale:double arcsine transformed proportion
#funnel(pes.ft,yaxis="sei")
#original scale
funnel(pes.ft,atransf=transf.ipft.hm,targ=list(ni=dat$total),yaxis="sei",xlab="Proportion")
```
```{r trim and fill with double arcsine transformed data}
pes.trimfill=trimfill(pes.ft)
#funnel(pes.trimfill)#transformed scale
funnel(pes.trimfill,atransf=transf.ipft.hm,targ=list(ni=dat$total),yaxis="sei",xlab="Proportion")#original scale
pes.adjusted=predict(pes.trimfill,transf=transf.ipft.hm,targ=list(ni=dat$total))
print(pes.adjusted)
```
```{r Egger's regression test with transformed proportions}
regtest(pes.ft,model="lm",predictor="sei")
```
```{r rank correlation (Kendall's tall) with transformed data}
ranktest(pes.ft)
```
```{r Vevea and Hedges (1995) Weight-Function Model}
weightfunct(ies.ft$yi,ies.ft$vi,steps=0.05)
```





