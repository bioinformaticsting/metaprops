Note: replace "#" (including the quote marks) with a suitable number
      replace "filename" (leave the quote marks as is) with the file name of your dataset
      replace "moderatora""mal1""mal2" with real names in your dataset
      replace "level1""level2" (leave the quote marks as is) with real names in your dataset
```{r install required packages}
install.packages('metafor')
install.packages('meta')
install.packages('weightr')
```
```{r load required packages}
library(metafor)
library(meta)
library(weightr)
```
```{r read data files}
dat=read.csv("filename.csv", header=T, sep=",")
```
```{r calculate overall and subgroup effect sizes without transformation}
ies=escalc(xi=cases, ni=total, measure="PR", data=dat) 
pes=rma(yi, vi, data=ies, method="DL", weighted=TRUE, slab=paste(author, year, sep=","))
pes.mal1=rma(yi, vi, data=ies, subset=moderatora=="level1", method="DL")
pes.mal2=rma(yi, vi, data=ies, subset=moderatora=="level2", method="DL")
print(pes)
print(pes.mal1)
print(pes.mal2)
```
```{r forest plot using raw proportions }
forest(pes,
       ylim=c("#", "#" ),
       xlim=c("#", "#"),
       rows=c("#":"#", "#":"#"),
       main="Effect size by moderatora (RE Model)",
       ilab=cbind(data=dat$cases, dat$total),
       ilab.xpos=c("#", "#"),
       refline=pes$b,
       at=c(seq(from="#", to="#", by="#")),
       xlab="Proportion",
       mlab="",
       cex="#",
       font="#"
       )
#Add lables
text("#", "#", pos="#", cex="#", font="#", "Author(s), Year")
text("#", c("#", "#"), pos="#", cex="#", font="#", c("level2", "level1"))
text(c("#", "#"), "#", pos="#", cex="#", font="#", c("Cases", "Total"))
text("#", "#", pos="#", font="#", cex="#", "Proportion [95% CI]")
#Add heterogeneity stats
#All studies
text("#", "#", pos="#", cex="#", font="#",
     bquote(paste("All studies(Q= ", .(formatC(pes$QE, digits=1, format="f")), ", df= ", .(pes$k - pes$p), ", p= ", .(formatC(pes$QEp,    format="f")), 
     "; ", I^2, "= ", .(formatC(pes$I2, digits=1, format="f")), "%",")")))
#Level 1 of moderator a
text("#", "#", pos="#", cex="#", font="#",
     bquote(paste("Subtotal(Q= ", .(formatC(pes.mal1$QE, digits=1, format="f")), ", df= ", .(pes.mal1$k - pes.mal1$p), ", p= ", .(formatC(pes.mal1$QEp, format="f")),
     "; ", I^2, "= ", .(formatC(pes.mal1$I2, digits=1, format="f")), "%",")")))
#level 2 of moderator a
text("#", "#", pos="#", cex="#", font="#",
     bquote(paste("Subtotal(Q= ", .(formatC(pes.mal2$QE, digits=1, format="f")), ", df= ", .(pes.mal2$k - pes.mal2$p), 
     ", p= ", .(formatC(pes.mal2$QEp, format="f")), 
     "; ", I^2, "= ", .(formatC(pes.mal2$I2, format="f")), "%", ")")))
#Add summary polygons for subgroups
#level 1 of moderator a
addpoly(pes.mal1,
        row="#",
        cex="#", font="#",
        mlab=""
         )
#level 2 of moderator a
addpoly(pes.mal2, 
        row="#", 
        cex="#", font="#",
        mlab=""  
         )
dev.copy(png, 'Effect size by moderatora.png')
dev.off()
```
```{r check evidence of heterogeneity}
print(pes)
```
```{r baujat plot}
baujat(pes)
```
```{r A set of diagnostics to id potential outliers and influential cases}
pes.inf=influence(pes)
plot(pes.inf)
```
```{r leave one out analysis}
leave1out(pes)
```
```{r subgroup analysis without transformation}
#assume a common variance
subganal.moderatora=rma(yi, vi, data=ies, mods=~moderatora, method="DL")
print(subganal.moderatora)
#do not assume a common variance (metaprop mode)
#dat.diffvar=data.frame(estimate=c(pes.mal1$b, pes.mal2$b), stderror=c(pes.mal1$se, pes.mal2$se), moderatora=c("level1", "level2"), tau2=round(c(pes.mal1$tau2, pes.mal2$tau2), "#"))
#subganal.moderatora=rma(estimate, sei=stderror, mods=~ moderatora, method="FE", data=dat.diffvar, digits=4)
#print(subganal.moderatora)
```
```{r funnel plot with raw proportions}
funnel(pes)
```
```{r trim and fill with raw proportions}
pes.trimfill=trimfill(pes)
funnel(pes.trimfill)
print(pes.trimfill)
```
```{r Egger's regression test with raw proportions}
regtest(pes, model="lm", predictor="sei")
```
```{r rank correlation (Kendall's tall) with raw proporitons}
ranktest(pes)
```
```{r Vevea and Hedges (1995) Weight-Function Model}
weightfunct(ies$yi, ies$vi, steps="#") 
```

