```{r install required packages}
#install.packages('metafor')
#install.packages('meta')
#install.packages('weightr')
```
```{r load required packages}
library(metafor)
library(meta)
library(weightr)
```
```{r read data files}
dat=read.csv("your working directory/filename.csv",header=T,sep=",")
```
```{r calculate overall and subgroup effect sizes without transformation}
ies=escalc(xi=cases,ni=total,measure="PR",data=dat) #note I changed r.ies to ies
pes=rma(yi,vi,data=ies,method="DL",weighted=TRUE, slab=paste(author, year, sep=", "))
pes.mal1=rma(yi,vi,data=ies,subset=moderatora=="level1",method="DL")
pes.mal2=rma(yi,vi,data=ies,subset=moderatora=="level2",method="DL")
print(pes,digits=3)
print(pes.mal1,digits=3)
print(pes.mal2,digits=3)
```
```{r forest plot using raw proportions }
forest(pes,
       ylim=c(-2,30),#vertical limits
       xlim=c(-2,2.1),#horizontal limits
       rows=c(25:13,7.6:2.6),#1 is the row above the line below;ylim and rows both determine the position of studies
       main="Effect size by moderator a (RE Model)",
       ilab=cbind(data=dat$cases, dat$total),#show cases and total
       ilab.xpos=c(-0.8, -0.4),#position of cases and total
       refline=pes$b,#reference line position
       at=c(seq(from=0,to=1.1,by=0.2)), #legendary lenghth
       xlab="Proportion",#legendary lable
       mlab="",
       cex=0.8,#overall size
       font=6,
       digits=3
       )
#Add lables
text(-2, 29,pos=4,cex=0.8,font=6,"Author(s), Year")#-2=x,17=y;font=2=bold
text(-2,c(8.9,26.3),pos=4, cex=0.8,font=6,c("level2", "level1"))#use c() to posit subgroup lables
text(c(-1, -0.6), 29,pos=4,cex=0.8,font=6,c("Cases", "Total"))
text(1.3,29,pos=4,font=6,cex=0.8,"Proportion [95% CI]")
#Add heterogeneity stats
#Two provinces
text(-2,-1.1,pos=4,cex=0.7,font=1,
     bquote(paste("All studies(Q = ",.(formatC(pes$QE, digits=1, format="f")), ", df = ", .(pes$k - pes$p),", p = ", .(formatC(pes$QEp, digits=2, format="f")), 
     "; ", I^2, " = ",.(formatC(pes$I2, digits=1, format="f")), "%",")")))
#Guangdong
text(-2,11.4,pos=4,cex=0.7,font=1,
     bquote(paste("Subtotal(Q = ",.(formatC(pes.mal1$QE, digits=1, format="f")), ", df = ", .(pes.mal1$k - pes.mal1$p),", p = ", .(formatC(pes.mal1$QEp, digits=2, format="f")),
     "; ", I^2, " = ",.(formatC(pes.mal1$I2, digits=1, format="f")), "%",")")))
#Guangxi
text(-2,1.1,pos=4,cex=0.7,font=3,
     bquote(paste("Subtotal(Q = ",.(formatC(pes.mal2$QE, digits=1, format="f")),", df = ", .(pes.mal2$k - pes.mal2$p), 
     ", p = ", .(formatC(pes.mal2$QEp, digits=2, format="f")), 
     "; ", I^2, " = ",.(formatC(pes.mal2$I2, digits=1, format="f")), "%",")")))
#Add summary polygons for subgroups
#Guangdong
addpoly(pes.mal1,
        row=11.4,#position
        cex=0.7,font=1,#font size and bold
        mlab="",
        digits=3)
#Guangxi
addpoly(pes.mal2, 
        row=1.1, 
        cex=0.7, font=1,
        mlab="",  
        digits=3)
dev.copy(png,'Effect size by moderator a.png')
dev.off()
```
```{r check evidence of heterogeneity}
print(pes,digits=2)
```
```{r baujat plot}
baujat(pes)
```
```{r A set of diagnostics to id potential outliers and influential cases}
pes.inf=influence(pes)
plot(pes.inf)
```
```{r leave one out analysis}
leave1out(pes)
```
```{r subgroup analysis without transformation}
#assume a common variance
subganal.moderatora=rma(yi,vi,data=ies,mods=~moderatora,method="DL")
print(subganal.moderatora)
#do not assume a common variance (metaprop mode)
#dat.diffvar= data.frame(estimate=c(pes.mal1$b, pes.mal2$b),stderror=c(pes.mal1$se, pes.mal2$se),moderatora = c("level1","level2"), tau2=round(c(pes.mal1$tau2, pes.mal2$tau2),3))
#subganal.moderatora=rma(estimate, sei=stderror, mods = ~ moderatora, method="FE", data=dat.diffvar, digits=4)
#print(subganal.moderatora,digits=3)
```
```{r funnel plot with raw proportions}
funnel(pes)
```
```{r trim and fill with raw proportions}
pes.trimfill=trimfill(pes)
funnel(pes.trimfill)
print(pes.trimfill,digits=2)
```
```{r Egger's regression test with raw proportions}
regtest(pes,model="lm",predictor="sei")
```
```{r rank correlation (Kendall's tall) with raw proporitons}
ranktest(pes)
```
```{r Vevea and Hedges (1995) Weight-Function Model}
weightfunct(ies$yi,ies$vi,steps=0.05) 
```

